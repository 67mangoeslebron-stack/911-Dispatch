<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>911 Dispatch V130 - Free Tier Fix</title>
    <style>
        :root { --bg: #020617; --panel: #1e293b; --accent: #38bdf8; --red: #ef4444; --gold: #eab308; --text: #f1f5f9; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; height: 100vh; display: flex; overflow: hidden; }
        .map-area { flex: 2; position: relative; background: #000; border-right: 2px solid #334155; }
        canvas { display: block; width: 100%; height: 100%; }
        .cad-area { flex: 1; display: flex; flex-direction: column; min-width: 450px; background: var(--panel); }
        .header { background: #0f172a; padding: 15px; border-bottom: 2px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .log { flex: 1; background: #000; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #334155; }
        .msg { padding: 8px 12px; border-radius: 4px; max-width: 85%; font-size: 14px; }
        .msg.caller { align-self: flex-start; background: #310000; border-left: 4px solid var(--red); }
        .msg.radio { align-self: flex-start; background: #1e1b4b; border-left: 4px solid var(--gold); color: var(--gold); }
        .msg.disp { align-self: flex-end; background: #0c4a6e; border-right: 4px solid var(--accent); }
        .msg.sys { align-self: center; font-size: 11px; color: #64748b; font-style: italic; }
        .unit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; background: #0f172a; }
        .u-btn { padding: 10px; background: #334155; border: 1px solid #475569; color: white; cursor: pointer; text-align: left; font-size: 11px; }
        .u-btn.selected { border-color: var(--gold); background: #422006; }
        .input-bar { padding: 15px; background: #1e293b; display: flex; flex-direction: column; gap: 10px; }
        input { background: #0f172a; border: 1px solid #475569; color: white; padding: 10px; font-family: monospace; text-transform: uppercase; }
        .action-btn { background: var(--accent); color: black; border: none; padding: 10px; font-weight: bold; cursor: pointer; }
        .mic-btn { padding: 10px; background: #334155; color: white; border: none; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .mic-btn.active { background: var(--red); box-shadow: 0 0 10px var(--red); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="map-area"><canvas id="map-canvas"></canvas></div>

<div class="cad-area">
    <div class="header">
        <div style="font-weight:bold;">METRO DISPATCH V130</div>
        <button id="mic-toggle" class="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
    </div>

    <div class="log" id="log">
        <div class="msg sys">SYSTEM READY. CLICK MAP THEN CLICK FORCE START.</div>
    </div>

    <div class="unit-grid" id="unit-grid">
        <div class="u-btn" id="PD-01" onclick="selectUnit('PD-01')">PD-01 (Patrol)</div>
        <div class="u-btn" id="EAGLE-1" onclick="selectUnit('EAGLE-1')">EAGLE-1 (Air PD)</div>
        <div class="u-btn" id="ENGINE-5" onclick="selectUnit('ENGINE-5')">ENGINE-5 (Fire)</div>
        <div class="u-btn" id="MEDIC-2" onclick="selectUnit('MEDIC-2')">MEDIC-2 (EMS)</div>
    </div>

    <div class="input-bar">
        <div style="font-size:10px; color:#94a3b8; font-weight:bold;">LOCATION VERIFICATION:</div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="inp-addr" placeholder="TYPE ADDRESS..." style="flex:1;">
            <button class="action-btn" onclick="verifyAddress()" style="background:var(--green); color:white; padding: 0 10px;">LOCK</button>
        </div>
        <button id="disp-btn" class="action-btn" style="background:var(--gold); opacity:0.4;" onclick="dispatch()" disabled>TRANSMIT DISPATCH</button>
        <button class="action-btn" onclick="manualStart()" style="background:#334155; color:#fff; font-size:10px;">FORCE START CALL</button>
    </div>
</div>

<script>
    const CONFIG = {
        apiKey: "sk_98138d8a2c18e25e0126f3d7ab0750fbcb527ee3c78c977a",
        voiceId: "FGY2WhTYpPnrIDTdsKH5"
    };

    let activeCall = { addr: "1505 CLEAVELAND WAY", intro: "Hello? My son isn't home! It's been 12 hours, please help!" };
    let selectedUnit = null;
    let verified = false;
    let micActive = false;
    const synth = window.speechSynthesis;

    // --- SPEECH RECOGNITION ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript;
        handleInput(transcript);
    };
    recognition.onerror = () => { console.log("Mic error, restarting..."); };
    recognition.onend = () => { if(micActive) recognition.start(); };

    function toggleMic() {
        const btn = document.getElementById('mic-toggle');
        if (!micActive) {
            try { recognition.start(); } catch(e){}
            micActive = true;
            btn.classList.add('active');
            addMsg('sys', "MICROPHONE LIVE");
        } else {
            recognition.stop();
            micActive = false;
            btn.classList.remove('active');
            addMsg('sys', "MICROPHONE MUTED");
        }
    }

    async function speakEleven(text) {
        addMsg('sys', "Contacting ElevenLabs...");
        try {
            const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${CONFIG.voiceId}`, {
                method: 'POST',
                headers: { 
                    'xi-api-key': CONFIG.apiKey, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ 
                    text: text, 
                    model_id: "eleven_turbo_v2_5", // UPDATED TO NEW FREE MODEL
                    voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                console.error("ElevenLabs Error:", errData);
                addMsg('sys', `API ERROR: ${errData.detail?.message || "Check Key Permissions"}`);
                fallbackSpeak(text); 
                return;
            }

            const blob = await response.blob();
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play();
        } catch (e) {
            console.error(e);
            addMsg('sys', "CONNECTION FAILED. USING BACKUP VOICE.");
            fallbackSpeak(text);
        }
    }

    function fallbackSpeak(text) {
        const ut = new SpeechSynthesisUtterance(text);
        synth.speak(ut);
    }

    function playRadio(text) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.15, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.value = 0.05;
        source.connect(gain); gain.connect(audioCtx.destination);
        source.start();

        const ut = new SpeechSynthesisUtterance(text);
        ut.rate = 1.1; ut.pitch = 0.8;
        synth.speak(ut);
    }

    function handleInput(text) {
        addMsg('disp', text);
        const lower = text.toLowerCase();
        
        if (lower.includes("location") || lower.includes("where") || lower.includes("address")) {
            setTimeout(() => {
                const r = "I'm at 1505 Cleaveland Way! Where is the officer?";
                addMsg('caller', r);
                speakEleven(r);
            }, 1000);
        } else if (lower.includes("name") || lower.includes("who")) {
            setTimeout(() => {
                const r = "His name is Marcus. He's only 14!";
                addMsg('caller', r);
                speakEleven(r);
            }, 1000);
        }
    }

    function selectUnit(id) {
        selectedUnit = id;
        document.querySelectorAll('.u-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(id).classList.add('selected');
        checkReady();
    }

    function verifyAddress() {
        const val = document.getElementById('inp-addr').value.toUpperCase();
        if(val.includes("1505") || val.includes("CLEAVELAND")) {
            verified = true;
            addMsg('sys', "LOCATION LOCKED: 1505 CLEAVELAND WAY");
            checkReady();
        }
    }

    function checkReady() {
        if(verified && selectedUnit) {
            const b = document.getElementById('disp-btn');
            b.disabled = false; b.style.opacity = "1";
        }
    }

    function dispatch() {
        const m = `${selectedUnit} copies. En route to Cleaveland Way.`;
        addMsg('radio', `[${selectedUnit}] ${m}`);
        playRadio(m);
        document.getElementById('disp-btn').disabled = true;
        document.getElementById('disp-btn').style.opacity = "0.4";
    }

    function addMsg(type, text) {
        const l = document.getElementById('log');
        const d = document.createElement('div');
        d.className = `msg ${type}`;
        d.innerText = text;
        l.appendChild(d);
        l.scrollTop = l.scrollHeight;
    }

    function manualStart() {
        addMsg('caller', activeCall.intro);
        speakEleven(activeCall.intro);
    }

    // Map Setup
    const canvas = document.getElementById('map-canvas');
    const ctx = canvas.getContext('2d');
    function draw() {
        canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight;
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle = "#1e293b";
        for(let i=0; i<canvas.width; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let i=0; i<canvas.height; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }
        requestAnimationFrame(draw);
    }
    draw();
</script>
</body>
</html>
